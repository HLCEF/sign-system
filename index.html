<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘æœƒå…¬æ–‡æ ¸ç« ç³»çµ±</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleSignIn()" async defer></script>
    
    <style>
        :root { --primary: #1a73e8; --success: #34a853; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 25px; }
        #google_signin_wrapper { display: flex; justify-content: center; margin-bottom: 20px; min-height: 40px; }
        #userProfile { text-align: center; margin-bottom: 20px; font-weight: bold; color: var(--primary); min-height: 24px; }
        .step-box { display: none; text-align: center; }
        .active { display: block; }
        .sig-preview-wrapper { margin: 15px 0; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff; }
        #sigPreview { max-width: 150px; display: block; margin: 0 auto; }
        .upload-zone { border: 2px dashed var(--primary); background: #f1f7ff; padding: 40px 20px; border-radius: 12px; cursor: pointer; margin: 20px 0; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        #fileList { text-align: left; font-size: 13px; color: #666; background: #f0f0f0; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; }
        #status { margin-top: 15px; font-size: 14px; color: var(--primary); font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0 0 15px 0;">ğŸ›ï¸ åŸºé‡‘æœƒæ ¸ç« ç³»çµ±</h2>
        <div id="google_signin_wrapper">
            <div id="google_signin_button"></div>
        </div>
    </div>

    <div id="userProfile">æ­£åœ¨æº–å‚™ Google ç™»å…¥...</div>

    <div id="stepInit" class="step-box">
        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
            âš ï¸ åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®šç°½åæª”ã€‚<br>è«‹æ‹æ”æˆ–ä¸Šå‚³ç°½åç…§ç‰‡ï¼Œç³»çµ±å°‡è‡ªå‹•å»èƒŒã€‚
        </div>
        <input type="file" id="sigInput" accept="image/*" style="display:none">
        <button class="btn btn-primary" onclick="document.getElementById('sigInput').click()">ğŸ“¸ ä¸Šå‚³ç°½ååœ–æª”</button>
    </div>

    <div id="stepApp" class="step-box">
        <div class="sig-preview-wrapper">
            <span style="font-size: 12px; color: #999;">ç›®å‰ä½¿ç”¨çš„ç°½ååœ–æ¡ˆï¼š</span>
            <img id="sigPreview" src="" alt="ç°½åé è¦½">
        </div>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <p id="fileName">ğŸ“‚ é»æ“Šé¸å–å¾…ç°½ PDF (å¯å¤šé¸)</p>
            <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none">
        </div>
        <div id="fileList"></div>
        <button class="btn btn-success" id="signBtn" onclick="processAllFiles()">ğŸš€ æ‰¹æ¬¡ç°½ç½²ä¸¦åŒæ­¥é›²ç«¯</button>
        <div id="status"></div>
    </div>
</div>

<script>
    // --- 2. æ ¸å¿ƒé…ç½® ---
    const CONFIG = {
        CLIENT_ID: "285014596888-r1heqas9q4tptdqm4qsr9rhle5rkejcl.apps.googleusercontent.com",
        GAS_URL: "https://script.google.com/macros/s/AKfycby0sZfRYWh6MRi2jZVAjdl1FA6XdPGHUCiyj4BsuDRmZJYJMXNds2THa-ioQme9ksE/exec",
        WHITE_THRESHOLD: 200 // æ•¸å­—è¶Šå°ï¼Œå»èƒŒè¶Šå¼·
    };

    let currentUserEmail = null;
    let selectedFiles = [];

    // --- 3. Google SSO é‚è¼¯ ---
    function initGoogleSignIn() {
        google.accounts.id.initialize({
            client_id: CONFIG.CLIENT_ID,
            callback: handleSignIn,
            auto_select: false,
            prompt: "select_account"
        });

        google.accounts.id.renderButton(
            document.getElementById("google_signin_button"),
            { theme: "outline", size: "large", text: "signin_with" }
        );
        document.getElementById('userProfile').innerText = "è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ";
    }

    function handleSignIn(response) {
        // è§£ç¢¼ JWT å–å¾—ä½¿ç”¨è€…è³‡è¨Š
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        currentUserEmail = payload.email;
        document.getElementById('userProfile').innerHTML = `<span>ğŸ‘¤ ä½¿ç”¨è€…ï¼š${payload.name}</span>`;
        document.getElementById('google_signin_wrapper').style.display = 'none';
        checkUserStatus();
    }

    // --- 4. ç°½åæª”ç‹€æ…‹ç®¡ç† ---
    function checkUserStatus() {
        const savedSig = localStorage.getItem(`sig_${currentUserEmail}`);
        const stepInit = document.getElementById('stepInit');
        const stepApp = document.getElementById('stepApp');
        
        if (!savedSig) {
            stepInit.classList.add('active');
            stepApp.classList.remove('active');
        } else {
            stepInit.classList.remove('active');
            stepApp.classList.add('active');
            document.getElementById('sigPreview').src = savedSig;
        }
    }

    // --- 5. è‡ªå‹•å»èƒŒè™•ç† ---
    document.getElementById('sigInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('status').innerText = "â³ æ­£åœ¨è™•ç†å½±åƒ...";

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < imgData.data.length; i += 4) {
                    // RGB åˆ¤å®š
                    const r = imgData.data[i];
                    const g = imgData.data[i+1];
                    const b = imgData.data[i+2];
                    if (r > CONFIG.WHITE_THRESHOLD && g > CONFIG.WHITE_THRESHOLD && b > CONFIG.WHITE_THRESHOLD) {
                        imgData.data[i+3] = 0; // é€æ˜
                    }
                }
                ctx.putImageData(imgData, 0, 0);
                localStorage.setItem(`sig_${currentUserEmail}`, canvas.toDataURL("image/png"));
                checkUserStatus();
                document.getElementById('status').innerText = "âœ… ç°½åè¨­å®šå®Œæˆ";
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // --- 6. PDF ç°½ç½²èˆ‡ä¸‹è¼‰ ---
    document.getElementById('fileInput').onchange = (e) => {
        selectedFiles = Array.from(e.target.files);
        const list = document.getElementById('fileList');
        if (selectedFiles.length > 0) {
            list.style.display = 'block';
            list.innerHTML = selectedFiles.map(f => `â€¢ ${f.name}`).join('<br>');
            document.getElementById('fileName').innerText = `å·²é¸å– ${selectedFiles.length} ä»½æ–‡ä»¶`;
        }
    };

    async function processAllFiles() {
        const status = document.getElementById('status');
        const sigBase64 = localStorage.getItem(`sig_${currentUserEmail}`);
        if (!sigBase64) return alert("è«‹å…ˆè¨­å®šç°½åæª”");

        const sigBytes = await fetch(sigBase64).then(res => res.arrayBuffer());

        for (const file of selectedFiles) {
            status.innerText = `ğŸ”„ è™•ç†ä¸­: ${file.name}`;
            try {
                const pdfDoc = await PDFLib.PDFDocument.load(await file.arrayBuffer());
                const sigImg = await pdfDoc.embedPng(sigBytes);
                // é è¨­ç°½åä½ç½® (å³ä¸‹)
                pdfDoc.getPages()[0].drawImage(sigImg, { x: 450, y: 100, width: 100, height: 50 });

                const pdfBytes = await pdfDoc.save();
                const serial = "F-" + Date.now().toString().slice(-6);
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([pdfBytes], {type: "application/pdf"}));
                link.download = `${serial}_${file.name}`;
                link.click();

                // åŒæ­¥ GAS (ä¸ç­‰å¾…çµæœ)
                fetch(CONFIG.GAS_URL, { 
                    method: "POST", 
                    mode: "no-cors", 
                    body: JSON.stringify({ serial, user: currentUserEmail, file: file.name, date: new Date().toLocaleString() }) 
                });
            } catch (err) {
                console.error(err);
            }
        }
        status.innerText = "âœ… ç°½ç½²å®Œæˆï¼è«‹æª¢æŸ¥ä¸‹è¼‰æ¸…å–®ã€‚";
    }
</script>
</body>
</html>

